name: "Static Analysis"
on:
  workflow_dispatch:
  push:
    branches:
      - 'V0.0Test'
      
env:
  REGISTRY: ghcr.io
  REPO_NAME: ${{ github.event.repository.name }}
  USER_NAME: ${{ github.actor }}
  VERSION: "latest"
  IMAGE_TAG: ${REGISTRY,,}"/"${USER_NAME,,}"/"${REPO_NAME,,}":"${VERSION,,}
  
jobs:
  variable_substitution:
    runs-on: ubuntu-20.04
    outputs:
      image: ${{ steps.set_image.outputs.image }}
    steps:
      - id: set_image
        run: echo "image=${{env.IMAGE_TAG}}" >> $GITHUB_OUTPUT

  static_analysis:
    name: static_analysis
    runs-on: ubuntu-20.04
    needs: variable_substitution
    container:
      image: ${{ needs.variable_substitution.outputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install CppCheck
        run: |
          apt-get install -y ninja-build

          CMAKE_VERSION=3.23.2 && \
          wget https://github.com/Kitware/CMake/releases/download/v$CMAKE_VERSION/cmake-$CMAKE_VERSION-Linux-x86_64.sh && \
          chmod a+x cmake-$CMAKE_VERSION-Linux-x86_64.sh && \
          ./cmake-$CMAKE_VERSION-Linux-x86_64.sh --skip-license --prefix=/usr/local && \
          rm cmake-$CMAKE_VERSION-Linux-x86_64.sh

          git clone --depth 1 https://github.com/danmar/cppcheck.git && \
          cmake -S cppcheck -B cppcheck/build -G Ninja -DCMAKE_BUILD_TYPE=Release && \
          cmake --build cppcheck/build --target install && \
          rm -fr cppcheck
          cppcheck --version

      - name: Run CppCheck
        run: |
          cppcheck --enable=all --language=c --std=c11 --output-file=cppcheck_report.txt --addon=./misra/misra.json -I ./Drivers/ -I ./Core/Inc/ ./Core/Src/main.c

      - name: Install and Run CppLint
        run: |
          python3 --version
          apt-get install python3-pip -y
          pip3 install cpplint
          cpplint --extensions=c --recursive ./Core/Src/main.c >> cpplint_report.txt 2>&1
        #cpplint --quiet --recursive Core/Src/main.c --error-exitcode=1 --extensions=c --output-file=cpplint_report.txt
        continue-on-error: true
        
      - uses: actions/upload-artifact@v3
        with:
          name: CppReport
          path: |
            ./cppcheck_report.txt
            ./cpplint_report.txt
